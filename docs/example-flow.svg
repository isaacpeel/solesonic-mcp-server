<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1200 700" width="100%" role="img" aria-label="Authorization flow: challenge, discovery, token use">
  <title>Authorization flow: challenge, discovery, token use</title>
  <desc>Client calls MCP without token, receives 401 with WWW-Authenticate, discovers resource metadata, fetches AS metadata, obtains token, calls MCP successfully.</desc>
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L10,3 L0,6 Z" fill="#555"/>
    </marker>
    <style type="text/css"><![CDATA[
      .actor { fill: #f5f5f5; stroke: #999; rx:6; ry:6; }
      .swim { stroke:#ddd; stroke-width:1; }
      .label { font: 600 16px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; fill:#222; }
      .small { font: 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; fill:#333; }
      .swim-label { font: 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; fill:white; }
      .note { fill:#FFF9C4; stroke:#BDB76B; }
      .arrow { stroke:#555; stroke-width:2; fill:none; marker-end:url(#arrow); }
      .arrow.dash { stroke-dasharray:5 5; }
    ]]></style>
  </defs>

  <!-- Actors -->
  <rect class="actor" x="40" y="30" width="180" height="44"/>
  <text class="label" x="130" y="58" text-anchor="middle">Client</text>

  <rect class="actor" x="510" y="30" width="270" height="44"/>
  <text class="label" x="645" y="58" text-anchor="middle">MCP Server (Resource Server)</text>

  <rect class="actor" x="980" y="30" width="180" height="44"/>
  <text class="label" x="1070" y="58" text-anchor="middle">Authorization Server</text>

  <!-- Lifelines -->
  <line class="swim" x1="130" y1="80" x2="130" y2="650"/>
  <line class="swim" x1="645" y1="80" x2="645" y2="650"/>
  <line class="swim" x1="1070" y1="80" x2="1070" y2="650"/>

  <!-- 1. Client -> MCP without token -->
  <text class="swim-label" x="387" y="120" text-anchor="middle">MCP request without token</text>
  <line class="arrow" x1="130" y1="135" x2="640" y2="135"/>

  <!-- 2. MCP -> Client 401 WWW-Authenticate -->
  <text class="swim-label" x="387" y="175" text-anchor="middle">401 Unauthorized with WWW-Authenticate</text>
  <line class="arrow dash" x1="645" y1="190" x2="130" y2="190"/>
  <rect class="note" x="45" y="205" width="210" height="60"/>
  <text class="small" x="150" y="230" text-anchor="middle">Extract resource_metadata URL</text>

  <!-- 3. Client -> MCP: GET well-known resource metadata -->
  <text class="swim-label" x="387" y="285" text-anchor="middle">GET /.well-known/oauth-protected-resource</text>
  <line class="arrow" x1="130" y1="300" x2="640" y2="300"/>

  <!-- 4. MCP -> Client: resource metadata with AS URL -->
  <text class="swim-label" x="387" y="345" text-anchor="middle">Resource metadata (authorization_servers, scopes)</text>
  <line class="arrow dash" x1="645" y1="360" x2="130" y2="360"/>
  <rect class="note" x="55" y="375" width="235" height="60"/>
  <text class="small" x="172" y="400" text-anchor="middle">Validate metadata, derive</text>
  <text class="small" x="172" y="420" text-anchor="middle">AS metadata URL</text>

  <!-- 5. Client -> AS: GET AS metadata -->
  <text class="swim-label" x="870" y="445" text-anchor="middle">GET /.well-known/oauth-authorization-server</text>
  <line class="arrow" x1="130" y1="460" x2="1070" y2="460"/>

  <!-- 6. AS -> Client: AS metadata -->
  <text class="swim-label" x="870" y="505" text-anchor="middle">Authorization server metadata</text>
  <line class="arrow dash" x1="1070" y1="520" x2="130" y2="520"/>

  <!-- 7. Client <-> AS: Token flow (abstracted) -->
  <rect class="note" x="300" y="545" width="690" height="44"/>
  <text class="small" x="645" y="572" text-anchor="middle">OAuth 2.1 authorization flow happens here</text>

  <!-- 8. Client -> MCP with token -->
  <text class="swim-label" x="387" y="620" text-anchor="middle">MCP request with access token</text>
  <line class="arrow" x1="130" y1="635" x2="640" y2="635"/>

  <!-- 9. MCP -> Client response -->
  <text class="swim-label" x="387" y="665" text-anchor="middle">MCP response</text>
  <line class="arrow dash" x1="645" y1="680" x2="130" y2="680"/>
</svg>
